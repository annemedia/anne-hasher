name: Build macOS Universal Binaries

on:
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-14

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin,aarch64-apple-darwin

      - name: Build CLI universal binary
        run: |
          NO_MTUNE_NATIVE=1 cargo build --release --target x86_64-apple-darwin --features "cli opencl"
          cargo build --release --target aarch64-apple-darwin --features "cli opencl"
          lipo -create -output anne-hasher-cli target/x86_64-apple-darwin/release/anne-hasher target/aarch64-apple-darwin/release/anne-hasher
          chmod +x anne-hasher-cli

      - name: Build GUI universal binary
        run: |
          NO_MTUNE_NATIVE=1 cargo build --release --target x86_64-apple-darwin --features "gui opencl"
          cargo build --release --target aarch64-apple-darwin --features "gui opencl"
          lipo -create -output anne-hasher-gui target/x86_64-apple-darwin/release/anne-hasher target/aarch64-apple-darwin/release/anne-hasher

      - name: Create GUI .app bundle
        run: |
          mkdir -p "Anne Hasher.app/Contents/MacOS"
          mkdir -p "Anne Hasher.app/Contents/Resources"
          cp anne-hasher-gui "Anne Hasher.app/Contents/MacOS/anne-hasher"
          chmod +x "Anne Hasher.app/Contents/MacOS/anne-hasher"
          
          # Create Info.plist - NO LSUIElement means dock icon shows
          echo '<?xml version="1.0" encoding="UTF-8"?>' > "Anne Hasher.app/Contents/Info.plist"
          echo '<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">' >> "Anne Hasher.app/Contents/Info.plist"
          echo '<plist version="1.0">' >> "Anne Hasher.app/Contents/Info.plist"
          echo '<dict>' >> "Anne Hasher.app/Contents/Info.plist"
          echo '    <key>CFBundleExecutable</key>' >> "Anne Hasher.app/Contents/Info.plist"
          echo '    <string>anne-hasher</string>' >> "Anne Hasher.app/Contents/Info.plist"
          echo '    <key>CFBundleIdentifier</key>' >> "Anne Hasher.app/Contents/Info.plist"
          echo '    <string>com.annemedia.anne-hasher</string>' >> "Anne Hasher.app/Contents/Info.plist"
          echo '    <key>CFBundleName</key>' >> "Anne Hasher.app/Contents/Info.plist"
          echo '    <string>Anne Hasher</string>' >> "Anne Hasher.app/Contents/Info.plist"
          echo '    <key>CFBundleIconFile</key>' >> "Anne Hasher.app/Contents/Info.plist"
          echo '    <string>AppIcon.icns</string>' >> "Anne Hasher.app/Contents/Info.plist"
          echo '    <key>NSHighResolutionCapable</key>' >> "Anne Hasher.app/Contents/Info.plist"
          echo '    <true/>' >> "Anne Hasher.app/Contents/Info.plist"
          echo '</dict>' >> "Anne Hasher.app/Contents/Info.plist"
          echo '</plist>' >> "Anne Hasher.app/Contents/Info.plist"
          
          # Create icon if exists
          if [ -f "icon.png" ]; then
            mkdir -p temp_icon.iconset
            sips -z 16 16 icon.png --out temp_icon.iconset/icon_16x16.png
            sips -z 32 32 icon.png --out temp_icon.iconset/icon_16x16@2x.png
            sips -z 32 32 icon.png --out temp_icon.iconset/icon_32x32.png
            sips -z 64 64 icon.png --out temp_icon.iconset/icon_32x32@2x.png
            sips -z 128 128 icon.png --out temp_icon.iconset/icon_128x128.png
            sips -z 256 256 icon.png --out temp_icon.iconset/icon_128x128@2x.png
            sips -z 256 256 icon.png --out temp_icon.iconset/icon_256x256.png
            sips -z 512 512 icon.png --out temp_icon.iconset/icon_256x256@2x.png
            sips -z 512 512 icon.png --out temp_icon.iconset/icon_512x512.png
            iconutil -c icns temp_icon.iconset -o "Anne Hasher.app/Contents/Resources/AppIcon.icns"
            rm -rf temp_icon.iconset
          fi

      - name: Create DMG
        run: |
          mkdir -p dmg_contents
          cp -R "Anne Hasher.app" dmg_contents/
          ln -s /Applications dmg_contents/Applications
          hdiutil create -volname "Anne Hasher" -srcfolder dmg_contents -ov -format UDZO -imagekey zlib-level=9 anne-hasher-gui.dmg

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: anne-hasher-macos
          path: |
            anne-hasher-cli
            anne-hasher-gui.dmg