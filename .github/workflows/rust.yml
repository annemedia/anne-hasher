name: Build macOS Universal Binary

on:
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-14

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin,aarch64-apple-darwin

      - name: Build universal binary
        run: |
          # Build both architectures
          NO_MTUNE_NATIVE=1 cargo build --release --target x86_64-apple-darwin --features "gui opencl"
          cargo build --release --target aarch64-apple-darwin --features "gui opencl"
          
          # Create universal binary
          lipo -create -output anne-hasher \
            target/x86_64-apple-darwin/release/anne-hasher \
            target/aarch64-apple-darwin/release/anne-hasher

      - name: Create app bundle
        run: |
          # Create .app structure
          mkdir -p "Anne Hasher.app/Contents/MacOS"
          cp anne-hasher "Anne Hasher.app/Contents/MacOS/"
          
          echo '<?xml version="1.0" encoding="UTF-8"?>' > "Anne Hasher.app/Contents/Info.plist"
          echo '<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">' >> "Anne Hasher.app/Contents/Info.plist"
          echo '<plist version="1.0">' >> "Anne Hasher.app/Contents/Info.plist"
          echo '<dict>' >> "Anne Hasher.app/Contents/Info.plist"
          echo '    <key>CFBundleExecutable</key>' >> "Anne Hasher.app/Contents/Info.plist"
          echo '    <string>anne-hasher</string>' >> "Anne Hasher.app/Contents/Info.plist"
          echo '    <key>CFBundleIdentifier</key>' >> "Anne Hasher.app/Contents/Info.plist"
          echo '    <string>com.annemedia.anne-hasher</string>' >> "Anne Hasher.app/Contents/Info.plist"
          echo '    <key>CFBundleName</key>' >> "Anne Hasher.app/Contents/Info.plist"
          echo '    <string>Anne Hasher</string>' >> "Anne Hasher.app/Contents/Info.plist"
          echo '    <key>LSUIElement</key>' >> "Anne Hasher.app/Contents/Info.plist"
          echo '    <true/>' >> "Anne Hasher.app/Contents/Info.plist"
          echo '</dict>' >> "Anne Hasher.app/Contents/Info.plist"
          echo '</plist>' >> "Anne Hasher.app/Contents/Info.plist"

      - name: Create DMG
        run: |
          # Create DMG
          hdiutil create -volname "Anne Hasher" \
            -srcfolder "Anne Hasher.app" \
            -ov -format UDZO \
            -imagekey zlib-level=9 \
            anne-hasher-macos.dmg

      - name: Upload DMG
        uses: actions/upload-artifact@v4
        with:
          name: anne-hasher-macos
          path: anne-hasher-macos.dmg